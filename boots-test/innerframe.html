<html>
    <head>
        <title>test</title>
    </head>
    <body onload="registerListener()">
        <p>this is a test</p>
        <button id="id_button" onclick="reportId()">Report ID</button>
        <p id="frame_id">??</p>
    </body>
    <script>
        // global state
        var instance_id = 0;
        var parent_window = null;

        // register the message listener
        function registerListener() {
            window.addEventListener(
                "message",
                (event) => {
                    // if (event.origin !== "https://forum.starmen.net/") return;
                    // alert(event.data);
                    if (parent_window == null) {
                        parent_window = event.source;
                    }
                    document.body.children[0].textContent = event.data;
                    handleMessage(event.data);
                },
                false,
            );
        }

        // message handler
        function handleMessage(msg) {
            const cmd_register = "REGISTER "
            if (msg.startsWith(cmd_register) && instance_id == 0) {
                instance_id = parseInt(msg.replace(cmd_register, ""));
                document.getElementById("frame_id").innerText = instance_id.toString();
                console.log("registered " + instance_id);
            }
        }

        // report the instance ID back to the source window
        function reportId() {
            if (parent_window != null) {
                parent_window.postMessage(instance_id.toString(), "*");
            }
        }

    </script>
</html>